# Issue05: カスタムストレージロケーション機能

## 概要

現在のTodoLogアプリケーションでは、タスクデータは固定のディレクトリとファイルに保存されています。この機能拡張により、ユーザーが保存先ディレクトリを指定できるようにし、さらに複数のファイルに分けてタスクを管理できるようにします。

## 目的

1. ユーザーが任意のディレクトリにタスクデータを保存できるようにする
2. 複数のタスクファイルを作成・管理できるようにする
3. 異なるプロジェクトやコンテキストごとにタスクを分離して管理できるようにする

## 実装計画

### フェーズ1: バックエンド拡張（サーバーサイド）

- [ ] 設定管理機能の実装
  - [ ] ユーザー設定を保存・読み込みするためのサービス作成
  - [ ] デフォルトのデータディレクトリとは別に、カスタムディレクトリのパスを保存する機能
  - [ ] 設定ファイルのスキーマ設計と検証

- [ ] ファイル操作サービスの拡張
  - [ ] 指定されたディレクトリにファイルを作成・読み込み・保存する機能
  - [ ] ディレクトリが存在しない場合の自動作成機能
  - [ ] ディレクトリ内のタスクファイル一覧を取得する機能
  - [ ] ファイル名のバリデーション

- [ ] APIエンドポイントの追加
  - [ ] `/api/settings` - 設定の取得・更新
  - [ ] `/api/storage/directories` - 利用可能なディレクトリ一覧の取得
  - [ ] `/api/storage/files` - 指定ディレクトリ内のタスクファイル一覧の取得
  - [ ] `/api/storage/files/:filename` - 特定のタスクファイルの操作

### フェーズ2: フロントエンド拡張（クライアントサイド）

- [ ] 設定画面の実装
  - [ ] データ保存先ディレクトリ設定UI
  - [ ] 現在のデータファイル表示と選択UI
  - [ ] 新規データファイル作成UI

- [ ] タスクファイル管理機能
  - [ ] 現在開いているタスクファイルの表示
  - [ ] タスクファイル切り替え機能
  - [ ] 新規タスクファイル作成機能
  - [ ] タスクファイルの名前変更・削除機能

- [ ] ナビゲーションの拡張
  - [ ] タスクファイル選択ドロップダウンまたはサイドバー
  - [ ] 最近使用したファイルのクイックアクセス

### フェーズ3: データ移行と互換性

- [ ] データ移行ツール
  - [ ] 既存のデータを新しい場所/ファイルに移行する機能
  - [ ] 移行中のデータ整合性確保

- [ ] 下位互換性の確保
  - [ ] 設定が存在しない場合のデフォルト動作の維持
  - [ ] 古いバージョンとの互換性確保

### フェーズ4: テストとドキュメント

- [ ] テスト
  - [ ] バックエンド単体テスト
  - [ ] フロントエンド単体テスト
  - [ ] 統合テスト
  - [ ] エッジケースのテスト（権限エラー、ディスク容量不足など）

- [ ] ドキュメント
  - [ ] ユーザーガイドの更新
  - [ ] API仕様書の更新
  - [ ] 開発者向けドキュメントの更新

## 技術的考慮事項

### セキュリティ
- ディレクトリトラバーサル攻撃の防止
- ファイルシステム権限の適切な処理
- ユーザー入力の厳格なバリデーション

### パフォーマンス
- 大量のファイルがある場合のディレクトリ読み込みパフォーマンス
- ファイル切り替え時のUIレスポンス

### UX設計
- 直感的なファイル選択・管理インターフェース
- エラー状態の適切な表示とリカバリー方法
- 初回使用時のガイダンス

## 成功基準

1. ユーザーが任意のディレクトリを保存先として指定できる
2. 複数のタスクファイルを作成・管理できる
3. ファイル間でのタスク切り替えがスムーズに行える
4. 既存のデータとの互換性が維持されている
5. すべてのエッジケースが適切に処理される

## タイムライン

- フェーズ1（バックエンド拡張）: 3日
- フェーズ2（フロントエンド拡張）: 3日
- フェーズ3（データ移行と互換性）: 2日
- フェーズ4（テストとドキュメント）: 2日

**合計予定期間**: 10日

## 実装時の追加考慮点

### 既存コードとの統合
- 現在の `FileService` クラスは `dataDir` を受け取れるようになっていますが、インスタンス生成後に変更する方法がありません。動的に変更できるようにメソッドを追加する必要があります。
- `TaskService` は `TASKS_FILE` が固定値になっているため、複数ファイル対応には修正が必要です。ファイル名を動的に設定できるようにする必要があります。

### 設定の保存場所
- 現在のフロントエンドの設定は `localStorage` に保存されていますが、カスタムストレージロケーションはサーバー側の設定です。
- サーバー側で設定を保存する新しい仕組みが必要です。例えば、固定の場所（`~/.todolog/settings.json`）に設定ファイルを保存することを検討してください。

### API設計の詳細化
- 新しいAPIエンドポイントの詳細な仕様（リクエスト/レスポンスの形式など）を明確にする必要があります。
- 特に、ディレクトリ選択やファイル操作に関するエンドポイントの入力検証は重要です。

### エラーハンドリング
- ディレクトリのアクセス権限エラー、ディスク容量不足、ファイル名の衝突など、様々なエラーケースの処理方法を詳細化する必要があります。
- フロントエンドでのエラー表示とリカバリー方法も考慮してください。

### UIフロー
- ファイル切り替え時のユーザー体験（未保存の変更がある場合の処理など）を考慮する必要があります。
- ファイル選択UIはドロップダウンよりも、サイドバーやタブ形式の方が使いやすい可能性があります。

### 実装に向けた提案
1. **バックエンド拡張**:
   - `FileService` を拡張して、動的にデータディレクトリとファイル名を変更できるようにする
   - `SettingsService` を新規作成し、アプリケーション設定を管理する
   - 設定ファイルは固定の場所に保存する

2. **フロントエンド拡張**:
   - `SettingsContext` を拡張して、サーバー側の設定も管理できるようにする
   - ファイル選択UIはサイドバーやタブ形式を検討する

3. **データ移行**:
   - 移行中のプログレス表示を追加する
   - 移行中のエラーからの回復メカニズムを実装する

4. **テスト強化**:
   - ファイルシステムの操作をモックした単体テストを充実させる
   - 権限エラーなどのエッジケースをシミュレートするテストを追加する
