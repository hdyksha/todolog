# Issue07: キーボードショートカット機能の修復

## 概要

TodoLogアプリケーションでキーボードショートカットが機能していない問題を調査し、修復するための計画を策定します。ショートカットはユーザーの生産性向上に重要な機能であり、早急に対応する必要があります。

## 現状の問題

アプリケーション上でキーボードショートカットが効かなくなっています。`useKeyboardShortcuts` フックは実装されていますが、実際のアプリケーション内で正しく統合されていない可能性があります。

## 調査計画

### フェーズ1: 問題の特定と原因分析

1. **現在のショートカット実装の調査**
   - [x] `useKeyboardShortcuts` フックの実装を確認
   - [x] ショートカットを使用しているコンポーネントの特定
   - [x] イベントリスナーの登録状況の確認

2. **問題の切り分け**
   - [x] グローバルショートカットとコンポーネント固有ショートカットの区別
   - [x] イベント伝播の問題の有無
   - [x] モーダルやフォーカス状態による影響

3. **テスト環境での検証**
   - [x] 既存のテストケースの確認
   - [x] 手動テストによる問題の再現

### フェーズ2: 解決策の設計

1. **アーキテクチャの見直し**
   - [x] グローバルなキーボードショートカット管理の検討
   - [x] `KeyboardShortcutsContext` の導入検討

2. **実装方針の決定**
   - [x] イベントリスナーの適切な登録場所
   - [x] コンポーネント間の責任分担
   - [x] ショートカットの優先順位付け

### フェーズ3: 実装

1. **KeyboardShortcutsContextの作成**
   - [x] コンテキスト基本構造の実装
   - [x] グローバルショートカットの定義
   - [x] ショートカット管理ロジックの実装

2. **App.tsxへの統合**
   - [x] KeyboardShortcutsProviderの追加
   - [x] 既存のコンテキスト階層への適切な配置

3. **ショートカットヘルプコンポーネントの統合**
   - [x] ShortcutHelpコンポーネントの拡張
   - [x] MainLayoutへの統合

4. **useKeyboardShortcutsフックの修正（必要に応じて）**
   - [x] イベント伝播の問題修正
   - [x] フォーカス管理の改善

### フェーズ4: テストと検証

1. **単体テスト**
   - [x] `KeyboardShortcutsContext` のテスト
   - [x] 修正した `useKeyboardShortcuts` フックのテスト

2. **統合テスト**
   - [x] 実際のコンポーネントでのショートカット動作確認
   - [x] モーダル表示時やフォーム入力時の挙動確認

3. **ユーザーテスト**
   - [x] 実際のユースケースでのショートカット動作確認
   - [x] エッジケースの検証

## 実装スケジュール

1. **フェーズ1: 問題の特定と原因分析** - 1日
2. **フェーズ2: 解決策の設計** - 0.5日
3. **フェーズ3: 実装** - 1.5日
4. **フェーズ4: テストと検証** - 1日

**合計予定工数: 4日**

## 期待される成果

- すべてのキーボードショートカットが正常に機能する
- ショートカットヘルプが利用可能で、現在使用可能なショートカットを表示する
- ショートカットの競合がなく、適切な優先順位で動作する
- フォーム入力中など、適切な状況でショートカットが無効化される

## 技術的考慮事項

1. **イベント伝播**
   - イベントバブリングとキャプチャリングの適切な処理
   - `stopPropagation()` と `preventDefault()` の適切な使用

2. **フォーカス管理**
   - フォーカス状態に応じたショートカットの有効/無効の切り替え
   - アクセシビリティへの配慮

3. **パフォーマンス**
   - 過剰なレンダリングの防止
   - イベントリスナーの適切な登録と解除

4. **テスト容易性**
   - モック可能な設計
   - テスト可能なコンポーネント分割

## リスクと対策

1. **リスク**: 既存のコードとの統合で予期せぬ副作用が発生する可能性
   **対策**: 段階的な実装と各段階でのテスト実施

2. **リスク**: ブラウザやOS固有のショートカットとの競合
   **対策**: 一般的なブラウザショートカットを避け、必要に応じて代替手段を提供

3. **リスク**: アクセシビリティの問題
   **対策**: WAI-ARIAガイドラインに従い、スクリーンリーダー対応を確認

## 結論

キーボードショートカット機能の修復は、ユーザー体験向上のために重要な取り組みです。本計画に従って実装を進めることで、効率的かつ堅牢なショートカット機能を提供できると考えられます。

## 実装完了報告

### 問題の原因

キーボードショートカット機能が動作しなかった主な原因は以下の通りでした：

1. **グローバルなショートカット管理の欠如**
   - 各コンポーネントで個別にショートカットを管理していたため、一貫性がなかった
   - コンポーネント間でのショートカットの競合が発生していた

2. **イベントリスナーの登録問題**
   - コンポーネントのマウント/アンマウント時にイベントリスナーの登録/解除が適切に行われていなかった
   - 複数のコンポーネントで同じキーのショートカットが登録されていた

3. **フォーカス管理の問題**
   - フォーム入力中などの特定の状態でショートカットが無効化されるべき場面で動作していた

### 実装した解決策

1. **KeyboardShortcutsContextの導入**
   - アプリケーション全体でショートカットを一元管理するコンテキストを作成
   - ショートカットの登録/解除を簡単に行えるAPIを提供
   - スコープ（グローバル、タスク一覧、タスク詳細など）によるショートカットの分類

2. **ショートカットヘルプモーダルの実装**
   - `Shift + ?` で表示できるヘルプモーダル
   - 現在利用可能なすべてのショートカットをスコープ別に表示
   - 視覚的に分かりやすいデザイン

3. **コンポーネント固有のショートカット**
   - 各ページやコンポーネントで必要なショートカットを登録
   - コンポーネントのマウント時に登録、アンマウント時に解除
   - フォーカス状態に応じた適切な有効/無効の切り替え

### 実装したショートカット一覧

#### グローバルショートカット
- `Shift + ?` - ショートカットヘルプを表示
- `Ctrl + D` - ダークモード/ライトモード切り替え
- `Shift + G` - ホームページへ移動
- `Ctrl + ,` - 設定ページへ移動

#### タスク一覧ページ
- `N` - 新しいタスクを作成
- `R` - フィルターをリセット

#### タスク詳細ページ
- `E` - メモを編集
- `Backspace` - 一覧に戻る
- `H` - マークダウンヘルプを表示

#### モーダル内
- `Escape` - モーダルを閉じる

### 技術的改善点

1. **パフォーマンス最適化**
   - useCallbackとuseMemoを使用して不要な再レンダリングを防止
   - イベントリスナーの効率的な登録と解除

2. **型安全性の向上**
   - TypeScriptの型定義を強化
   - コンポーネント間のインターフェースを明確化

3. **アクセシビリティ対応**
   - キーボードナビゲーションの改善
   - スクリーンリーダー対応

### 今後の展望

1. **ショートカットのカスタマイズ機能**
   - ユーザーが好みのキーにショートカットを割り当てられる機能
   - 設定の永続化

2. **コンテキスト認識型ショートカット**
   - 現在の状態やフォーカスに応じて適切なショートカットを提示
   - より直感的なユーザー体験

3. **ショートカットの競合検出**
   - 登録時に競合するショートカットを検出する機能
   - 優先順位に基づく自動解決

この実装により、TodoLogアプリケーションのキーボードショートカット機能が完全に修復され、ユーザーの生産性向上に貢献できるようになりました。
