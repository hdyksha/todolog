# TodoLog アーキテクチャ設計ドキュメント

## 1. システム概要

TodoLogは、タスク管理のためのWebアプリケーションです。ユーザーはタスクの作成、編集、削除、完了状態の管理などの基本的なタスク管理機能を利用できます。また、タスクにメモを追加したり、優先度を設定したり、カテゴリ分けしたりすることも可能です。

### 1.1 主要機能

- タスクのCRUD操作（作成、読み取り、更新、削除）
- タスクの完了状態の切り替え
- タスクへのメモ追加
- タスクの優先度設定
- タスクのカテゴリ分け
- タスクの期限設定
- データのバックアップと復元
- データのインポート/エクスポート

## 2. アーキテクチャ概要

TodoLogは、フロントエンドとバックエンドが分離されたクライアント-サーバーアーキテクチャを採用しています。

### 2.1 全体構成

```
┌─────────────────┐      ┌─────────────────┐      ┌─────────────────┐
│                 │      │                 │      │                 │
│   クライアント     │ <──> │   APIサーバー    │ <──> │  ファイルシステム  │
│   (React SPA)   │      │   (Express)    │      │   (JSON保存)    │
│                 │      │                 │      │                 │
└─────────────────┘      └─────────────────┘      └─────────────────┘
```

### 2.2 技術スタック

#### フロントエンド
- **フレームワーク**: React
- **言語**: TypeScript
- **ビルドツール**: Vite
- **状態管理**: React Context API
- **UIライブラリ**: 独自コンポーネント
- **HTTP通信**: Fetch API

#### バックエンド
- **ランタイム**: Node.js
- **フレームワーク**: Express
- **言語**: TypeScript
- **データ永続化**: ファイルシステム (fs/promises)
- **ロギング**: Winston
- **バリデーション**: Zod

## 3. バックエンドアーキテクチャ

バックエンドは、関心の分離を重視した多層アーキテクチャを採用しています。

### 3.1 レイヤー構成

```
┌─────────────────────────────────────────────────────────────┐
│                        アプリケーション                        │
└───────────────────────────────┬─────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────┐
│                         ミドルウェア層                         │
│                                                             │
│  ・リクエストロギング    ・エラーハンドリング    ・レート制限       │
│  ・CORS設定           ・セキュリティ対策      ・キャッシュ制御    │
└───────────────────────────────┬─────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────┐
│                         ルーティング層                         │
│                                                             │
│  ・URLパスとコントローラーのマッピング                            │
└───────────────────────────────┬─────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────┐
│                        コントローラー層                        │
│                                                             │
│  ・リクエスト処理        ・入力バリデーション    ・レスポンス生成    │
└───────────────────────────────┬─────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────┐
│                         サービス層                           │
│                                                             │
│  ・ビジネスロジック      ・データ操作         ・ドメインルール適用  │
└───────────────────────────────┬─────────────────────────────┘
                                │
┌───────────────────────────────▼─────────────────────────────┐
│                       データアクセス層                         │
│                                                             │
│  ・ファイル読み書き      ・データ形式変換      ・バックアップ処理    │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 主要コンポーネント

#### 3.2.1 ミドルウェア

- **errorHandler**: エラー処理を一元化
- **requestLogger**: リクエストのロギング
- **rateLimiter**: APIリクエストの制限
- **securityMiddleware**: セキュリティヘッダーの設定
- **cacheControl**: キャッシュ制御

#### 3.2.2 コントローラー

- **TaskController**: タスク関連のリクエスト処理
  - タスクの取得、作成、更新、削除
  - タスクの完了状態切り替え
  - タスクのメモ更新
  - カテゴリ一覧の取得
  - バックアップ関連の処理
  - インポート/エクスポート処理

#### 3.2.3 サービス

- **TaskService**: タスク管理のビジネスロジック
  - タスクのCRUD操作
  - タスクの検索とフィルタリング
  - カテゴリ管理
  - バックアップ処理
  - インポート/エクスポート処理

- **FileService**: ファイル操作の抽象化
  - JSONファイルの読み書き
  - バックアップファイルの管理
  - ディレクトリ操作

#### 3.2.4 モデル

- **Task**: タスクのデータモデルと型定義
  - Zodスキーマによるバリデーション
  - TypeScriptインターフェース

#### 3.2.5 ユーティリティ

- **logger**: ロギング機能
- **error**: カスタムエラークラス
- **data-validator**: データバリデーション

## 4. データモデル

### 4.1 タスクモデル

```typescript
interface Task {
  id: string;          // ユニークID
  title: string;       // タスクのタイトル
  completed: boolean;  // 完了状態
  priority: Priority;  // 優先度（High, Medium, Low）
  category?: string;   // カテゴリ（オプション）
  dueDate?: string;    // 期限（ISO形式の文字列）
  createdAt: string;   // 作成日時（ISO形式の文字列）
  updatedAt: string;   // 更新日時（ISO形式の文字列）
  memo?: string;       // メモ（オプション）
}

enum Priority {
  High = 'high',
  Medium = 'medium',
  Low = 'low'
}
```

### 4.2 データ永続化

データはJSONファイルとして保存されます。主なファイル：

- **tasks.json**: タスクデータの保存
- **tasks.json.[timestamp].bak**: バックアップファイル

## 5. API設計

RESTful APIの原則に従い、リソース指向の設計を採用しています。

### 5.1 エンドポイント一覧

| メソッド | エンドポイント | 説明 |
|---------|--------------|------|
| GET | /api/tasks | タスク一覧の取得 |
| GET | /api/tasks/:id | 特定のタスクの取得 |
| POST | /api/tasks | 新しいタスクの作成 |
| PUT | /api/tasks/:id | タスクの更新 |
| DELETE | /api/tasks/:id | タスクの削除 |
| PUT | /api/tasks/:id/toggle | タスクの完了状態の切り替え |
| PUT | /api/tasks/:id/memo | タスクのメモ更新 |
| GET | /api/categories | カテゴリ一覧の取得 |
| POST | /api/backups | バックアップの作成 |
| GET | /api/backups | バックアップ一覧の取得 |
| POST | /api/backups/:filename/restore | バックアップからの復元 |
| GET | /api/export | タスクデータのエクスポート |
| POST | /api/import | タスクデータのインポート |
| GET | /health | ヘルスチェック |

### 5.2 リクエスト/レスポンス形式

すべてのAPIはJSONフォーマットでデータをやり取りします。

#### リクエスト例（タスク作成）

```json
POST /api/tasks
Content-Type: application/json

{
  "title": "買い物に行く",
  "priority": "medium",
  "category": "買い物",
  "dueDate": "2025-04-25T15:00:00Z",
  "memo": "牛乳、卵、パンを買う"
}
```

#### レスポンス例

```json
HTTP/1.1 201 Created
Content-Type: application/json

{
  "id": "5b41bf03-50f9-42d5-b11c-48e43ef18f47",
  "title": "買い物に行く",
  "completed": false,
  "priority": "medium",
  "category": "買い物",
  "dueDate": "2025-04-25T15:00:00Z",
  "createdAt": "2025-04-19T01:57:24Z",
  "updatedAt": "2025-04-19T01:57:24Z",
  "memo": "牛乳、卵、パンを買う"
}
```

## 6. セキュリティ設計

### 6.1 実装済みのセキュリティ対策

- **Helmet**: セキュリティヘッダーの設定
- **CORS**: クロスオリジンリクエストの制限
- **レート制限**: DoS攻撃対策
- **入力バリデーション**: インジェクション攻撃対策
- **エラーハンドリング**: 詳細なエラー情報の隠蔽

### 6.2 今後の対策予定

- **認証**: JWT認証の実装
- **認可**: ロールベースのアクセス制御
- **監査ログ**: セキュリティイベントのロギング
- **HTTPS**: 暗号化通信の強制

## 7. パフォーマンス最適化

### 7.1 実装済みの最適化

- **キャッシュ制御**: 適切なCache-Controlヘッダーの設定
- **ETag**: 条件付きリクエストによる帯域幅の節約
- **圧縮**: レスポンスの圧縮
- **レスポンスタイムアウト**: 長時間実行リクエストの制限

### 7.2 今後の最適化予定

- **クエリ最適化**: 大量データ時のフィルタリング効率化
- **ページネーション**: 大量データの分割取得
- **インデックス**: 検索パフォーマンスの向上
- **キャッシュレイヤー**: メモリキャッシュの導入

## 8. スケーラビリティ

現在のアーキテクチャは単一サーバーを前提としていますが、将来的には以下の拡張が可能です：

### 8.1 水平スケーリング

- **ステートレス設計**: サーバーインスタンスの複数化
- **ロードバランサー**: リクエストの分散
- **共有ストレージ**: データの一元管理

### 8.2 垂直スケーリング

- **リソース最適化**: メモリ使用量の削減
- **非同期処理**: 長時間実行タスクの分離
- **バッチ処理**: 定期的なメンテナンス処理

## 9. 監視とロギング

### 9.1 ロギング戦略

- **アプリケーションログ**: Winstonによる構造化ログ
- **アクセスログ**: リクエスト情報の記録
- **エラーログ**: 例外とスタックトレースの記録
- **監査ログ**: セキュリティイベントの記録

### 9.2 ログレベル

- **debug**: 開発時のデバッグ情報
- **info**: 通常の操作情報
- **warn**: 潜在的な問題
- **error**: エラーと例外

## 10. 今後の展望

### 10.1 機能拡張

- **ユーザー認証**: マルチユーザー対応
- **共有機能**: タスクの共有とコラボレーション
- **通知**: リマインダーと通知機能
- **タグ**: より柔軟なタスク分類

### 10.2 技術的改善

- **データベース**: ファイルベースからDBMSへの移行
- **キャッシュ**: Redis等を使用したキャッシュ層の追加
- **マイクロサービス**: 機能ごとのサービス分割
- **コンテナ化**: Docker/Kubernetesによるデプロイ
